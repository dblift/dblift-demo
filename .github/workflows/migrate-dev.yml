name: Deploy to Development

on:
  push:
    branches:
      - develop
    paths:
      - 'migrations/**/*.sql'
      - 'config/dblift-postgresql.yaml'
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: read

jobs:
  migrate:
    name: Run Migrations on Dev Database
    runs-on: ubuntu-latest
    environment: development
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: dblift_user
          POSTGRES_PASSWORD: dblift_pass
          POSTGRES_DB: dblift_demo
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate migrations
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            --network host \
            -e DBLIFT_DB_URL=jdbc:postgresql://localhost:5432/dblift_demo \
            -e DBLIFT_DB_USER=dblift_user \
            -e DBLIFT_DB_PASSWORD=dblift_pass \
            -e DBLIFT_DB_SCHEMA=public \
            ghcr.io/cmodiano/dblift:latest validate \
            --config /workspace/config/dblift-postgresql.yaml \
            --log-format text,json,html \
            --log-dir /workspace/logs

      - name: Run migrations
        run: |
          set +e  # Don't exit on error, we want to capture output
          
          echo "::group::Running Migrations"
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            --network host \
            -e DBLIFT_DB_URL=jdbc:postgresql://localhost:5432/dblift_demo \
            -e DBLIFT_DB_USER=dblift_user \
            -e DBLIFT_DB_PASSWORD=dblift_pass \
            -e DBLIFT_DB_SCHEMA=public \
            ghcr.io/cmodiano/dblift:latest migrate \
            --config /workspace/config/dblift-postgresql.yaml \
            --log-format text,json,html \
            --log-dir /workspace/logs > migrate_output.txt 2>&1
          MIGRATE_EXIT=$?
          cat migrate_output.txt
          echo "::endgroup::"
          
          # Extract migration summary
          SUCCESS_COUNT=$(grep -c "Successfully applied migration" migrate_output.txt 2>/dev/null || echo "0")
          FAILED_COUNT=$(grep -c "Failed to execute" migrate_output.txt 2>/dev/null || echo "0")
          
          # Create step summary
          {
            echo "## ðŸš€ Migration Summary"
            echo ""
            echo "âœ… **Successful:** ${SUCCESS_COUNT}"
            if [ "${FAILED_COUNT}" != "0" ]; then
              echo "âŒ **Failed:** ${FAILED_COUNT}"
            fi
            echo ""
            if [ "${SUCCESS_COUNT}" -gt "0" ]; then
              echo "**Applied Migrations:**"
              echo '```'
              grep "Successfully applied migration" migrate_output.txt | sed 's/.*Successfully applied migration //'
              echo '```'
            fi
          } >> "$GITHUB_STEP_SUMMARY"
          
          # Create annotation
          if [ "${FAILED_COUNT}" != "0" ]; then
            echo "::error title=Migration Failed::${FAILED_COUNT} migration(s) failed"
          else
            echo "::notice title=Migrations Applied::Successfully applied ${SUCCESS_COUNT} migration(s)"
          fi
          
          # Exit with original exit code
          exit $MIGRATE_EXIT

      - name: Upload migration logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: migration-logs
          path: logs/
          retention-days: 30

      - name: Check for drift
        if: success()
        continue-on-error: true
        run: |
          set +e  # Don't exit on error
          
          echo "::group::Drift Detection"
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            --network host \
            -e DBLIFT_DB_URL=jdbc:postgresql://localhost:5432/dblift_demo \
            -e DBLIFT_DB_USER=dblift_user \
            -e DBLIFT_DB_PASSWORD=dblift_pass \
            -e DBLIFT_DB_SCHEMA=public \
            ghcr.io/cmodiano/dblift:latest diff \
            --config /workspace/config/dblift-postgresql.yaml > drift_output.txt 2>&1
          DRIFT_EXIT=$?
          cat drift_output.txt
          echo "::endgroup::"
          
          # Always create summary, even if drift check fails
          ERROR_COUNT=$(grep -oE 'Critical differences found: [0-9]+' drift_output.txt | grep -oE '[0-9]+' 2>/dev/null || echo "0")
          
          # Create summary (must happen before exit)
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ðŸ” Schema Drift Detection" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          if [ "$DRIFT_EXIT" -eq 0 ]; then
            echo "âœ… **No drift detected** - Database schema matches migrations" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ **Drift detected:** ${ERROR_COUNT} difference(s) found" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            
            # Extract table modifications with details
            echo "### Table Modifications" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            
            grep "Table '" drift_output.txt | while IFS= read -r line; do
              TABLE=$(echo "$line" | sed "s/.*Table '\([^']*\)'.*/\1/")
              MODS=$(echo "$line" | sed "s/.*modified_cols=\[\([^\]]*\)\].*/\1/" | sed "s/'//g")
              EXTRA_CONST=$(echo "$line" | sed "s/.*extra_constraints=\[\([^\]]*\)\].*/\1/" | sed "s/'//g")
              
              echo "**${TABLE}**" >> "$GITHUB_STEP_SUMMARY"
              if [ -n "$MODS" ] && [ "$MODS" != "" ]; then
                echo "- Modified columns: \`${MODS}\`" >> "$GITHUB_STEP_SUMMARY"
              fi
              if [ -n "$EXTRA_CONST" ] && [ "$EXTRA_CONST" != "" ]; then
                echo "- Extra constraints: \`${EXTRA_CONST}\`" >> "$GITHUB_STEP_SUMMARY"
              fi
              echo "" >> "$GITHUB_STEP_SUMMARY"
            done
            
            # Extract index differences
            INDEX_COUNT=$(grep -c "Index '" drift_output.txt 2>/dev/null || echo "0")
            if [ "$INDEX_COUNT" -gt 0 ]; then
              echo "### Index Differences (${INDEX_COUNT})" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              grep "Index '" drift_output.txt | sed "s/.*Index '\([^']*\)'.*/\1/" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
            fi
            
            # Extract trigger differences
            TRIGGER_LINE=$(grep "Trigger diff summary" drift_output.txt 2>/dev/null)
            if [ -n "$TRIGGER_LINE" ]; then
              TRIGGERS=$(echo "$TRIGGER_LINE" | sed "s/.*modified: \[\([^\]]*\)\].*/\1/" | sed "s/'//g")
              if [ -n "$TRIGGERS" ] && [ "$TRIGGERS" != "" ]; then
                echo "### Trigger Differences" >> "$GITHUB_STEP_SUMMARY"
                echo '```' >> "$GITHUB_STEP_SUMMARY"
                echo "$TRIGGERS" | tr ',' '\n' >> "$GITHUB_STEP_SUMMARY"
                echo '```' >> "$GITHUB_STEP_SUMMARY"
                echo "" >> "$GITHUB_STEP_SUMMARY"
              fi
            fi
            
            echo "ðŸ“„ **Full details in the 'Drift Detection' section above**" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          # Create annotation
          if [ "$ERROR_COUNT" != "0" ]; then
            echo "::warning title=Schema Drift::Found ${ERROR_COUNT} difference(s) - see job summary for details"
          fi
          
          # Don't fail the workflow on drift (it's expected in demo)
          exit 0

