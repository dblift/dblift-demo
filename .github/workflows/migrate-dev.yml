name: Deploy to Development

on:
  push:
    branches:
      - develop
    paths:
      - 'migrations/**/*.sql'
      - 'config/dblift-postgresql.yaml'
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: read

jobs:
  migrate:
    name: Run Migrations on Dev Database
    runs-on: ubuntu-latest
    environment: development
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: dblift_user
          POSTGRES_PASSWORD: dblift_pass
          POSTGRES_DB: dblift_demo
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate migrations
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            --network host \
            -e DBLIFT_DB_URL=jdbc:postgresql://localhost:5432/dblift_demo \
            -e DBLIFT_DB_USER=dblift_user \
            -e DBLIFT_DB_PASSWORD=dblift_pass \
            -e DBLIFT_DB_SCHEMA=public \
            ghcr.io/cmodiano/dblift:latest validate \
            --config /workspace/config/dblift-postgresql.yaml \
            --log-format text,json,html \
            --log-dir /workspace/logs

      - name: Run migrations
        id: migrate
        run: |
          set +e  # Don't exit on error, we want to capture output
          
          echo "::group::Running Migrations"
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            --network host \
            -e DBLIFT_DB_URL=jdbc:postgresql://localhost:5432/dblift_demo \
            -e DBLIFT_DB_USER=dblift_user \
            -e DBLIFT_DB_PASSWORD=dblift_pass \
            -e DBLIFT_DB_SCHEMA=public \
            ghcr.io/cmodiano/dblift:latest migrate \
            --config /workspace/config/dblift-postgresql.yaml \
            --log-format text,json,html \
            --log-dir /workspace/logs > migrate_output.txt 2>&1
          MIGRATE_EXIT=$?
          cat migrate_output.txt
          echo "::endgroup::"
          
          # Extract migration summary
          SUCCESS_COUNT=$(grep -c "Successfully applied migration" migrate_output.txt 2>/dev/null || echo "0")
          FAILED_COUNT=$(grep -c "Failed to execute" migrate_output.txt 2>/dev/null || echo "0")
          
          echo "migrations_success=${SUCCESS_COUNT}" >> "$GITHUB_OUTPUT"
          echo "migrations_failed=${FAILED_COUNT}" >> "$GITHUB_OUTPUT"
          
          # Create step summary
          {
            echo "## ðŸš€ Migration Summary"
            echo ""
            echo "âœ… **Successful:** ${SUCCESS_COUNT}"
            if [ "${FAILED_COUNT}" != "0" ]; then
              echo "âŒ **Failed:** ${FAILED_COUNT}"
            fi
            echo ""
            if [ "${SUCCESS_COUNT}" -gt 0 ]; then
              echo "**Applied Migrations:**"
              echo '```'
              grep "Successfully applied migration" migrate_output.txt | sed 's/.*Successfully applied migration //' || true
              echo '```'
            fi
          } >> "$GITHUB_STEP_SUMMARY"
          
          # Exit with original exit code
          exit $MIGRATE_EXIT

      - name: Upload migration logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: migration-logs
          path: logs/
          retention-days: 30

      - name: Check for drift
        if: success()
        id: drift-check
        continue-on-error: true
        run: |
          set +e  # Don't exit on error
          
          echo "::group::Drift Detection"
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            --network host \
            -e DBLIFT_DB_URL=jdbc:postgresql://localhost:5432/dblift_demo \
            -e DBLIFT_DB_USER=dblift_user \
            -e DBLIFT_DB_PASSWORD=dblift_pass \
            -e DBLIFT_DB_SCHEMA=public \
            ghcr.io/cmodiano/dblift:latest diff \
            --config /workspace/config/dblift-postgresql.yaml > drift_output.txt 2>&1
          DRIFT_EXIT=$?
          cat drift_output.txt
          echo "::endgroup::"
          
          # Extract key findings from drift output
          ERROR_COUNT=$(grep -oE 'Critical differences found: [0-9]+' drift_output.txt | grep -oE '[0-9]+' || echo "0")
          TABLE_COUNT=$(grep -c "Table '" drift_output.txt 2>/dev/null || echo "0")
          INDEX_COUNT=$(grep -c "Index '" drift_output.txt 2>/dev/null || echo "0")
          
          # Create step summary
          {
            echo "## ðŸ” Schema Drift Detection"
            echo ""
            if [ "$DRIFT_EXIT" -eq 0 ]; then
              echo "âœ… **No drift detected** - Database schema matches migrations"
            else
              echo "âš ï¸ **Drift detected:** ${ERROR_COUNT} difference(s) found"
              echo ""
              if [ "$TABLE_COUNT" -gt 0 ]; then
                echo "**Tables with differences:** ${TABLE_COUNT}"
                echo '```'
                grep "Table '" drift_output.txt | sed "s/.*Table '\([^']*\)'.*/\1/" | head -10
                echo '```'
              fi
              if [ "$INDEX_COUNT" -gt 0 ]; then
                echo ""
                echo "**Indexes with differences:** ${INDEX_COUNT}"
              fi
              echo ""
              echo "ðŸ“„ See detailed drift report in workflow logs above"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
          
          # Create annotations for visibility
          if [ "$ERROR_COUNT" != "0" ]; then
            echo "::warning title=Schema Drift::Found ${ERROR_COUNT} difference(s) between migrations and database schema"
          fi
          
          exit $DRIFT_EXIT

