name: Deploy to Development

on:
  push:
    branches:
      - develop
    paths:
      - 'migrations/**/*.sql'
      - 'config/dblift-postgresql.yaml'
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: read

jobs:
  migrate:
    name: Run Migrations on Dev Database
    runs-on: ubuntu-latest
    environment: development
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: dblift_user
          POSTGRES_PASSWORD: dblift_pass
          POSTGRES_DB: dblift_demo
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate migrations
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            --network host \
            -e DBLIFT_DB_URL=jdbc:postgresql://localhost:5432/dblift_demo \
            -e DBLIFT_DB_USER=dblift_user \
            -e DBLIFT_DB_PASSWORD=dblift_pass \
            -e DBLIFT_DB_SCHEMA=public \
            ghcr.io/cmodiano/dblift:latest validate \
            --config /workspace/config/dblift-postgresql.yaml \
            --log-format text,json,html \
            --log-dir /workspace/logs

      - name: Run migrations
        run: |
          set +e  # Don't exit on error, we want to capture output
          
          echo "::group::Running Migrations"
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            --network host \
            -e DBLIFT_DB_URL=jdbc:postgresql://localhost:5432/dblift_demo \
            -e DBLIFT_DB_USER=dblift_user \
            -e DBLIFT_DB_PASSWORD=dblift_pass \
            -e DBLIFT_DB_SCHEMA=public \
            ghcr.io/cmodiano/dblift:latest migrate \
            --config /workspace/config/dblift-postgresql.yaml \
            --log-format text,json,html \
            --log-dir /workspace/logs > migrate_output.txt 2>&1
          MIGRATE_EXIT=$?
          cat migrate_output.txt
          echo "::endgroup::"
          
          # Extract migration summary
          SUCCESS_COUNT=$(grep -c "Successfully applied migration" migrate_output.txt 2>/dev/null || echo "0")
          FAILED_COUNT=$(grep -c "Failed to execute" migrate_output.txt 2>/dev/null || echo "0")
          
          # Create step summary
          {
            echo "## ðŸš€ Migration Summary"
            echo ""
            echo "âœ… **Successful:** ${SUCCESS_COUNT}"
            if [ "${FAILED_COUNT}" != "0" ]; then
              echo "âŒ **Failed:** ${FAILED_COUNT}"
            fi
            echo ""
            if [ "${SUCCESS_COUNT}" -gt "0" ]; then
              echo "**Applied Migrations:**"
              echo '```'
              grep "Successfully applied migration" migrate_output.txt | sed 's/.*Successfully applied migration //'
              echo '```'
            fi
          } >> "$GITHUB_STEP_SUMMARY"
          
          # Create annotation
          if [ "${FAILED_COUNT}" != "0" ]; then
            echo "::error title=Migration Failed::${FAILED_COUNT} migration(s) failed"
          else
            echo "::notice title=Migrations Applied::Successfully applied ${SUCCESS_COUNT} migration(s)"
          fi
          
          # Exit with original exit code
          exit $MIGRATE_EXIT

      - name: Upload migration logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: migration-logs
          path: logs/
          retention-days: 30

      - name: Check for drift
        if: success()
        continue-on-error: true
        run: |
          set +e  # Don't exit on error
          
          echo "::group::Drift Detection"
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            --network host \
            -e DBLIFT_DB_URL=jdbc:postgresql://localhost:5432/dblift_demo \
            -e DBLIFT_DB_USER=dblift_user \
            -e DBLIFT_DB_PASSWORD=dblift_pass \
            -e DBLIFT_DB_SCHEMA=public \
            ghcr.io/cmodiano/dblift:latest diff \
            --config /workspace/config/dblift-postgresql.yaml > drift_output.txt 2>&1
          DRIFT_EXIT=$?
          cat drift_output.txt
          echo "::endgroup::"
          
          # Always create summary, even if drift check fails
          ERROR_COUNT=$(grep -oE 'Critical differences found: [0-9]+' drift_output.txt | grep -oE '[0-9]+' 2>/dev/null || echo "0")
          
          # Create summary (must happen before exit)
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## ðŸ” Schema Drift Detection" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          if [ "$DRIFT_EXIT" -eq 0 ]; then
            echo "âœ… **No drift detected** - Database schema matches migrations" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ **Found ${ERROR_COUNT} difference(s)** between migrations and live database" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            
            # Show detailed differences for each table
            echo "### ðŸ“‹ Table Differences" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            
            # Parse each table and its modifications
            grep -A 20 "Table '.*' modifications:" drift_output.txt | while IFS= read -r line; do
              if echo "$line" | grep -q "Table '.*' modifications:"; then
                # Extract table name
                TABLE_NAME=$(echo "$line" | grep -oP "Table '\K[^']+")
                echo "#### \`${TABLE_NAME}\`" >> "$GITHUB_STEP_SUMMARY"
              elif echo "$line" | grep -q "Modified column '"; then
                # Extract column name
                COL_NAME=$(echo "$line" | grep -oP "Modified column '\K[^']+")
                echo "- **Column \`${COL_NAME}\`** changed:" >> "$GITHUB_STEP_SUMMARY"
              elif echo "$line" | grep -q "data_type:"; then
                # Extract data type change
                DATA_TYPE=$(echo "$line" | grep -oP "data_type: \(\K[^)]+")
                FROM_TYPE=$(echo "$DATA_TYPE" | cut -d',' -f1 | tr -d "'" | xargs)
                TO_TYPE=$(echo "$DATA_TYPE" | cut -d',' -f2 | tr -d "'" | xargs)
                echo "  - Data type: \`${FROM_TYPE}\` â†’ \`${TO_TYPE}\`" >> "$GITHUB_STEP_SUMMARY"
              elif echo "$line" | grep -q "default:"; then
                # Extract default value change
                DEFAULT=$(echo "$line" | grep -oP "default: \(\K[^)]+")
                FROM_DEFAULT=$(echo "$DEFAULT" | cut -d',' -f1 | tr -d "'" | xargs)
                TO_DEFAULT=$(echo "$DEFAULT" | cut -d',' -f2 | xargs)
                echo "  - Default value: \`${FROM_DEFAULT}\` â†’ \`${TO_DEFAULT}\`" >> "$GITHUB_STEP_SUMMARY"
              elif echo "$line" | grep -q "Extra constraints details:"; then
                # Extract constraint names
                CONSTRAINTS=$(echo "$line" | grep -oP "Extra constraints details: \[\K[^]]+")
                echo "- **Added constraints:** \`${CONSTRAINTS}\`" >> "$GITHUB_STEP_SUMMARY"
                echo "" >> "$GITHUB_STEP_SUMMARY"
              fi
            done
            
            # Show index differences
            INDEX_COUNT=$(grep -c "Index '.*' has differences:" drift_output.txt 2>/dev/null || echo "0")
            if [ "$INDEX_COUNT" -gt 0 ]; then
              echo "### ðŸ” Index Differences (${INDEX_COUNT})" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              grep "Index '.*' has differences:" drift_output.txt | while IFS= read -r line; do
                INDEX_NAME=$(echo "$line" | grep -oP "Index '\K[^']+")
                COLS_CHANGED=$(echo "$line" | grep -oP "columns_changed=\K\w+")
                echo "- **\`${INDEX_NAME}\`**: Column definition changed (${COLS_CHANGED})" >> "$GITHUB_STEP_SUMMARY"
              done
              echo "" >> "$GITHUB_STEP_SUMMARY"
            fi
            
            # Show trigger differences
            if grep -q "Trigger diff summary.*modified:" drift_output.txt; then
              echo "### âš¡ Trigger Differences" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              TRIGGERS=$(grep "Trigger diff summary" drift_output.txt | grep -oP "modified: \[\K[^]]+")
              echo "$TRIGGERS" | tr ',' '\n' | sed "s/'//g" | sed 's/^[[:space:]]*//' | while read trigger; do
                if [ -n "$trigger" ]; then
                  echo "- **\`${trigger}\`**: Trigger definition differs from migration" >> "$GITHUB_STEP_SUMMARY"
                fi
              done
              echo "" >> "$GITHUB_STEP_SUMMARY"
            fi
            
            echo "---" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### ðŸ’¡ What This Means" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Most differences are **normal PostgreSQL behavior**:" >> "$GITHUB_STEP_SUMMARY"
            echo "- PostgreSQL adds type casts to default values (e.g., \`'system'::character varying\`)" >> "$GITHUB_STEP_SUMMARY"
            echo "- Foreign keys without explicit names get system-generated names" >> "$GITHUB_SUMMARY"
            echo "- Enum types show their full type name instead of just \`TEXT\`" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**These are NOT errors** - Your schema is correctly applied!" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "ðŸ“„ For complete SQL-level details, expand the 'Drift Detection' section in the workflow log above" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          # Create annotation
          if [ "$ERROR_COUNT" != "0" ]; then
            echo "::notice title=Schema Drift::Found ${ERROR_COUNT} PostgreSQL representation differences (expected - see summary for details)"
          fi
          
          # Don't fail the workflow on drift (it's expected in demo)
          exit 0

