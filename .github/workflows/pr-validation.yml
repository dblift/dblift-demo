name: PR SQL Validation

on:
  pull_request:
    paths:
      - 'migrations/**/*.sql'
      - 'examples/migrations/**/*.sql'
      - 'config/.dblift_rules.yaml'
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  checks: write

jobs:
  validate-sql:
    name: Validate SQL Migrations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diff

      - name: Get changed SQL files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            migrations/**/*.sql
            examples/migrations/**/*.sql

      - name: List changed migrations
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed SQL files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

      - name: Run DBLift validation
        if: steps.changed-files.outputs.any_changed == 'true'
        id: validate
        continue-on-error: true
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "Running DBLift validation using the lightweight image..."
          docker run --rm \
            -v "${PWD}:/workspace" \
            -e CHANGED_FILES \
            ghcr.io/cmodiano/dblift-validation:latest

      - name: Collect validation artifacts
        if: steps.changed-files.outputs.any_changed == 'true'
        id: artifacts
        shell: python
        run: |
          import json
          import os
          from pathlib import Path

          output_path = Path(os.environ["GITHUB_OUTPUT"])
          summary_path = Path(".dblift") / "validation-summary.json"
          sarif_path = Path(".dblift") / "validation-results.sarif"

          def write(name: str, value: str) -> None:
              with output_path.open("a", encoding="utf-8") as fh:
                  fh.write(f"{name}={value}\n")

          if summary_path.exists():
              data = json.loads(summary_path.read_text(encoding="utf-8"))
              write("summary_path", str(summary_path))
              write("errors", str(data.get("errors", 0)))
              write("warnings", str(data.get("warnings", 0)))
              write("infos", str(data.get("infos", 0)))
          else:
              print("::warning::Validation summary not found.")
              write("summary_path", "")
              write("errors", "0")
              write("warnings", "0")
              write("infos", "0")

          if sarif_path.exists():
              write("sarif_path", str(sarif_path))
          else:
              print("::warning::SARIF report not found.")
              write("sarif_path", "")

      - name: Upload SARIF to GitHub Security
        if: steps.changed-files.outputs.any_changed == 'true' && steps.artifacts.outputs.sarif_path != ''
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: ${{ steps.artifacts.outputs.sarif_path }}
          category: sql-validation

      - name: Create PR comment with validation results
        if: steps.changed-files.outputs.any_changed == 'true' && (steps.artifacts.outputs.summary_path != '' || steps.artifacts.outputs.sarif_path != '')
        uses: actions/github-script@v7
        env:
          SUMMARY_PATH: ${{ steps.artifacts.outputs.summary_path }}
          SARIF_PATH: ${{ steps.artifacts.outputs.sarif_path }}
        with:
          script: |
            const fs = require('fs');

            const summaryPath = process.env.SUMMARY_PATH;
            const sarifPath = process.env.SARIF_PATH;

            const summary = summaryPath && fs.existsSync(summaryPath)
              ? JSON.parse(fs.readFileSync(summaryPath, 'utf8'))
              : { errors: 0, warnings: 0, infos: 0 };

            const sarif = sarifPath && fs.existsSync(sarifPath)
              ? JSON.parse(fs.readFileSync(sarifPath, 'utf8'))
              : { runs: [{ results: [] }] };

            const results = sarif.runs?.[0]?.results ?? [];

            const errors = summary.errors ?? 0;
            const warnings = summary.warnings ?? 0;
            const infos = summary.infos ?? 0;

            let status = 'âœ… All validations passed!';
            let emoji = 'âœ…';

            if (errors > 0) {
              status = `âŒ ${errors} error(s) found`;
              emoji = 'âŒ';
            } else if (warnings > 0) {
              status = `âš ï¸ ${warnings} warning(s) found`;
              emoji = 'âš ï¸';
            }

            let comment = `## ${emoji} SQL Validation Results\n\n`;
            comment += `**Status:** ${status}\n\n`;
            comment += `| Severity | Count |\n`;
            comment += `|----------|-------|\n`;
            comment += `| Errors   | ${errors} |\n`;
            comment += `| Warnings | ${warnings} |\n`;
            comment += `| Info     | ${infos} |\n\n`;

            if (results.length > 0) {
              comment += `### Issues Found\n\n`;

              results.forEach(result => {
                const severity = result.level === 'error' ? 'âŒ' : result.level === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
                const location = result.locations?.[0]?.physicalLocation ?? {};
                const artifact = location.artifactLocation || {};
                const rawUri = artifact.uri || '';
                let file;
                try {
                  file = decodeURIComponent(rawUri);
                } catch {
                  file = rawUri;
                }
                if (artifact.uriBaseId === 'ROOTPATH') {
                  file = file.replace(/^ROOTPATH[\\/]/, '');
                }
                const line = location.region?.startLine ?? '?';

                comment += `${severity} **${result.ruleId}** (Line ${line})\n`;
                comment += `ğŸ“„ \`${file}\`\n`;
                comment += `> ${result.message?.text ?? 'No message provided.'}\n\n`;
              });
            }

            comment += `\n---\n`;
            comment += `ğŸ’¡ **Tip:** Check the [Security](../../security/code-scanning) tab for detailed SARIF analysis.\n`;
            comment += `ğŸ“– Review our [validation rules](../blob/main/config/.dblift_rules.yaml) for more information.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if errors found
        if: steps.validate.outcome == 'failure'
        run: |
          echo "âŒ SQL validation failed. Please fix the errors above."
          exit 1

