name: PR SQL Validation

on:
  pull_request:
    paths:
      - 'migrations/**/*.sql'
      - 'examples/migrations/**/*.sql'
      - 'config/.dblift_rules.yaml'
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  checks: write

jobs:
  validate-sql:
    name: Validate SQL Migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diff

      - name: Get changed SQL files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            migrations/**/*.sql
            examples/migrations/**/*.sql

      - name: List changed migrations
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed SQL files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

      - name: Validate SQL with DBLift Docker Image
        if: steps.changed-files.outputs.any_changed == 'true'
        id: validate
        continue-on-error: true
        run: |
          echo "Validating SQL migrations with DBLift..."
          mapfile -t FILES < <(echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | sed '/^$/d')
          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "No SQL files to validate."
            exit 0
          fi

          ARGS=()
          for file in "${FILES[@]}"; do
            ARGS+=("/workspace/${file}")
          done

          echo "Files passed to validator:"
          printf ' - %s\n' "${FILES[@]}"

          docker run --rm \
            -v "$(pwd):/workspace" \
            ghcr.io/cmodiano/dblift:latest \
            validate-sql "${ARGS[@]}" \
            --dialect postgresql \
            --rules-file /workspace/config/.dblift_rules.yaml \
            --format github-actions

      - name: Generate SARIF report with DBLift
        if: steps.changed-files.outputs.any_changed == 'true'
        id: sarif_raw
        shell: bash
        continue-on-error: true
        run: |
          echo "Generating SARIF report..."
          mapfile -t FILES < <(echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | sed '/^$/d')
          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "No SQL files to include in SARIF."
            echo "sarif_path=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ARGS=()
          for file in "${FILES[@]}"; do
            ARGS+=("/workspace/${file}")
          done

          echo "Files passed to SARIF validator:"
          printf ' - %s\n' "${FILES[@]}"

          set +e
          {
            docker run --rm \
              -v "$(pwd):/workspace" \
              ghcr.io/cmodiano/dblift:latest \
              validate-sql "${ARGS[@]}" \
              --dialect postgresql \
              --rules-file /workspace/config/.dblift_rules.yaml \
              --format sarif
          } > validation-results.sarif 2> sarif.log
          exit_code=$?
          set -e

          if [[ $exit_code -ne 0 ]]; then
            echo "::warning::validate-sql exited with code ${exit_code}; SARIF output may be incomplete."
          fi

          if [[ ! -s validation-results.sarif ]]; then
            echo "::warning::SARIF report missing or empty; skipping upload/comment."
            rm -f validation-results.sarif
            exit 0
          fi

      - name: Normalize SARIF output
        if: steps.changed-files.outputs.any_changed == 'true'
        id: sarif
        shell: python
        run: |
          import json
          import os
          from pathlib import Path

          sarif_path = Path("validation-results.sarif")
          output_path = Path(os.environ["GITHUB_OUTPUT"])

          def write_output(value: str) -> None:
              with output_path.open("a", encoding="utf-8") as fh:
                  fh.write(f"sarif_path={value}\n")

          if not sarif_path.exists() or sarif_path.stat().st_size == 0:
              print("::warning::SARIF report missing or empty; skipping upload/comment.")
              if sarif_path.exists():
                  sarif_path.unlink()
              write_output("")
              raise SystemExit(0)

          raw = sarif_path.read_text(encoding="utf-8")
          start = raw.find("{")
          end = raw.rfind("}")
          if start == -1 or end == -1:
              print("::warning::SARIF payload missing JSON object.")
              write_output("")
              raise SystemExit(0)

          clean = raw[start:end + 1]
          try:
              json.loads(clean)
          except json.JSONDecodeError as exc:
              print(f"::warning::Invalid SARIF JSON after cleanup: {exc}")
              write_output("")
              raise SystemExit(0)

          sarif_path.write_text(clean, encoding="utf-8")
          write_output("validation-results.sarif")

      - name: Upload SARIF to GitHub Security
        if: steps.changed-files.outputs.any_changed == 'true' && steps.sarif.outputs.sarif_path != ''
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: validation-results.sarif
          category: sql-validation

      - name: Create PR comment with validation results
        if: steps.changed-files.outputs.any_changed == 'true' && steps.sarif.outputs.sarif_path != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            
            let sarifRaw;
            try {
              sarifRaw = fs.readFileSync('validation-results.sarif', 'utf8').trim();
            } catch (err) {
              core.warning(`SARIF file not found: ${err.message}`);
              return;
            }
            
            if (!sarifRaw) {
              core.warning('SARIF file is empty; skipping PR comment.');
              return;
            }
            
            let sarif;
            try {
              sarif = JSON.parse(sarifRaw);
            } catch (err) {
              core.warning(`Failed to parse SARIF JSON: ${err.message}`);
              return;
            }
            
            const results = sarif.runs?.[0]?.results || [];
            
            const errors = results.filter(r => r.level === 'error').length;
            const warnings = results.filter(r => r.level === 'warning').length;
            const infos = results.filter(r => r.level === 'note' || r.level === 'info').length;
            
            let status = '‚úÖ All validations passed!';
            let emoji = '‚úÖ';
            
            if (errors > 0) {
              status = `‚ùå ${errors} error(s) found`;
              emoji = '‚ùå';
            } else if (warnings > 0) {
              status = `‚ö†Ô∏è ${warnings} warning(s) found`;
              emoji = '‚ö†Ô∏è';
            }
            
            let comment = `## ${emoji} SQL Validation Results\n\n`;
            comment += `**Status:** ${status}\n\n`;
            comment += `| Severity | Count |\n`;
            comment += `|----------|-------|\n`;
            comment += `| Errors   | ${errors} |\n`;
            comment += `| Warnings | ${warnings} |\n`;
            comment += `| Info     | ${infos} |\n\n`;
            
            if (results.length > 0) {
              comment += `### Issues Found\n\n`;
              
              results.forEach(result => {
                const severity = result.level === 'error' ? '‚ùå' : result.level === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                const location = result.locations[0].physicalLocation;
                const file = location.artifactLocation.uri;
                const line = location.region.startLine;
                
                comment += `${severity} **${result.ruleId}** (Line ${line})\n`;
                comment += `üìÑ \`${file}\`\n`;
                comment += `> ${result.message.text}\n\n`;
              });
            }
            
            comment += `\n---\n`;
            comment += `üí° **Tip:** Check the [Security](../../security/code-scanning) tab for detailed SARIF analysis.\n`;
            comment += `üìñ Review our [validation rules](../blob/main/config/.dblift_rules.yaml) for more information.`;
            
            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if errors found
        if: steps.validate.outcome == 'failure'
        run: |
          echo "‚ùå SQL validation failed. Please fix the errors above."
          exit 1

